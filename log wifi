import psutil
import time
import socket
from datetime import datetime

# ===== CONFIG =====
CHECK_INTERVAL = 1          # giây
MIN_DURATION = 4            # CHỈ log phiên > 4s
LOG_FILE = "suspicious_sessions.log"

# Các port phổ biến / hợp pháp
SAFE_PORTS = {
    443,    # HTTPS
    53,     # DNS
    80,     # HTTP (vẫn log nhưng phân loại riêng)
    123,    # NTP
    5228,   # Google
    3478,   # STUN / WebRTC
    8080,
    8443,
}

# key = (pid, remote_ip, remote_port)
active_sessions = {}

# cache DNS để tránh resolve lặp / treo
dns_cache = {}

print("Tool đang chạy (log PHIÊN TCP > 4s)...")

# ===== HÀM PHÂN LOẠI =====
def classify_port(port):
    if port == 80:
        return "HTTP (không mã hoá)"
    if port not in SAFE_PORTS:
        return f"PORT LẠ ({port})"
    return None

def resolve_ip(ip):
    if ip in dns_cache:
        return dns_cache[ip]

    try:
        host, _, _ = socket.gethostbyaddr(ip)
    except:
        host = "Unknown"

    dns_cache[ip] = host
    return host

# ===== LOOP CHÍNH =====
while True:
    now = time.time()
    seen = set()

    for conn in psutil.net_connections(kind="inet"):
        # chỉ TCP
        if conn.type != socket.SOCK_STREAM:
            continue

        if not conn.raddr or not conn.pid:
            continue

        remote_ip, remote_port = conn.raddr

        # bỏ loopback IPv4 + IPv6
        if remote_ip.startswith("127.") or remote_ip == "::1":
            continue

        violation = classify_port(remote_port)
        if not violation:
            continue

        key = (conn.pid, remote_ip, remote_port)
        seen.add(key)

        if key not in active_sessions:
            try:
                proc = psutil.Process(conn.pid)
                app_name = proc.name()
            except:
                app_name = "Unknown"

            active_sessions[key] = {
                "app": app_name,
                "ip": remote_ip,
                "port": remote_port,
                "type": violation,
                "start": now,
            }

    # ===== KẾT THÚC PHIÊN =====
    finished = []

    for key, session in list(active_sessions.items()):
        if key not in seen:
            start = session["start"]
            end = now
            duration = int(end - start)

            # ❗ CHỈ LOG PHIÊN > 4s
            if duration > MIN_DURATION:
                start_str = datetime.fromtimestamp(start).strftime("%Y-%m-%d %H:%M:%S")
                end_str = datetime.fromtimestamp(end).strftime("%Y-%m-%d %H:%M:%S")
                hostname = resolve_ip(session["ip"])

                log = (
                    f"APP: {session['app']}\n"
                    f"DEST: {session['ip']}:{session['port']}\n"
                    f"HOST: {hostname}\n"
                    f"TYPE: {session['type']}\n"
                    f"START: {start_str}\n"
                    f"END:   {end_str}\n"
                    f"DURATION: {duration}s\n"
                    f"{'-'*40}\n"
                )

                with open(LOG_FILE, "a", encoding="utf-8") as f:
                    f.write(log)

            finished.append(key)

    for key in finished:
        del active_sessions[key]

    time.sleep(CHECK_INTERVAL)
